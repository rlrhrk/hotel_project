/*
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
(function(a,k,c,j){var h="ontouchstart" in k;var g=(function(){var m=c.createElement("div"),l=c.documentElement;if(!("pointerEvents" in m.style)){return false}m.style.pointerEvents="auto";m.style.pointerEvents="x";l.appendChild(m);var n=k.getComputedStyle&&k.getComputedStyle(m,"").pointerEvents==="auto";l.removeChild(m);return !!n})();var f=h?"touchstart":"mousedown",e=h?"touchmove":"mousemove",d=h?"touchend":"mouseup";eCancel=h?"touchcancel":"mouseup";var b={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};function i(l,m){this.w=a(k);this.el=a(l);this.options=a.extend({},b,m);this.init()}i.prototype={init:function(){var l=this;l.reset();l.el.data("nestable-group",this.options.group);l.placeEl=a('<div class="'+l.options.placeClass+'"/>');a.each(this.el.find(l.options.itemNodeName),function(q,p){l.setParent(a(p))});l.el.on("click","button",function(q){if(l.dragEl||(!h&&q.button!==0)){return}var s=a(q.currentTarget),p=s.data("action"),r=s.parent(l.options.itemNodeName);if(p==="collapse"){l.collapseItem(r)}if(p==="expand"){l.expandItem(r)}});var o=function(p){var q=a(p.target);if(!q.hasClass(l.options.handleClass)){if(q.closest("."+l.options.noDragClass).length){return}q=q.closest("."+l.options.handleClass)}if(!q.length||l.dragEl||(!h&&p.button!==0)||(h&&p.touches.length!==1)){return}p.preventDefault();l.dragStart(h?p.touches[0]:p)};var n=function(p){if(l.dragEl){p.preventDefault();l.dragMove(h?p.touches[0]:p)}};var m=function(p){if(l.dragEl){p.preventDefault();l.dragStop(h?p.touches[0]:p)}};if(h){l.el[0].addEventListener(f,o,false);k.addEventListener(e,n,false);k.addEventListener(d,m,false);k.addEventListener(eCancel,m,false)}else{l.el.on(f,o);l.w.on(e,n);l.w.on(d,m)}},serialize:function(){var l,m=0,n=this;step=function(r,p){var o=[],q=r.children(n.options.itemNodeName);q.each(function(){var t=a(this),s=a.extend({},t.data()),u=t.children(n.options.listNodeName);if(u.length){s.children=step(u,p+1)}o.push(s)});return o};l=step(n.el.find(n.options.listNodeName).first(),m);return l},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(l){l.removeClass(this.options.collapsedClass);l.children('[data-action="expand"]').hide();l.children('[data-action="collapse"]').show();l.children(this.options.listNodeName).show()},collapseItem:function(l){var m=l.children(this.options.listNodeName);if(m.length){l.addClass(this.options.collapsedClass);l.children('[data-action="collapse"]').hide();l.children('[data-action="expand"]').show();l.children(this.options.listNodeName).hide()}},expandAll:function(){var l=this;l.el.find(l.options.itemNodeName).each(function(){l.expandItem(a(this))})},collapseAll:function(){var l=this;l.el.find(l.options.itemNodeName).each(function(){l.collapseItem(a(this))})},setParent:function(l){if(l.children(this.options.listNodeName).length){l.prepend(a(this.options.expandBtnHTML));l.prepend(a(this.options.collapseBtnHTML))}l.children('[data-action="expand"]').hide()},unsetParent:function(l){l.removeClass(this.options.collapsedClass);l.children("[data-action]").remove();l.children(this.options.listNodeName).remove()},dragStart:function(n){var q=this.mouse,r=a(n.target),m=r.closest(this.options.itemNodeName);this.placeEl.css("height",m.height());q.offsetX=n.offsetX!==j?n.offsetX:n.pageX-r.offset().left;q.offsetY=n.offsetY!==j?n.offsetY:n.pageY-r.offset().top;q.startX=q.lastX=n.pageX;q.startY=q.lastY=n.pageY;this.dragRootEl=this.el;this.dragEl=a(c.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",m.width());m.after(this.placeEl);m[0].parentNode.removeChild(m[0]);m.appendTo(this.dragEl);a(c.body).append(this.dragEl);this.dragEl.css({left:n.pageX-q.offsetX,top:n.pageY-q.offsetY});var o,l,p=this.dragEl.find(this.options.itemNodeName);for(o=0;o<p.length;o++){l=a(p[o]).parents(this.options.listNodeName).length;if(l>this.dragDepth){this.dragDepth=l}}},dragStop:function(l){var m=this.dragEl.children(this.options.itemNodeName).first();m[0].parentNode.removeChild(m[0]);this.placeEl.replaceWith(m);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(n){var q,v,x,t,m,u=this.options,r=this.mouse;this.dragEl.css({left:n.pageX-r.offsetX,top:n.pageY-r.offsetY});r.lastX=r.nowX;r.lastY=r.nowY;r.nowX=n.pageX;r.nowY=n.pageY;r.distX=r.nowX-r.lastX;r.distY=r.nowY-r.lastY;r.lastDirX=r.dirX;r.lastDirY=r.dirY;r.dirX=r.distX===0?0:r.distX>0?1:-1;r.dirY=r.distY===0?0:r.distY>0?1:-1;var s=Math.abs(r.distX)>Math.abs(r.distY)?1:0;if(!r.moving){r.dirAx=s;r.moving=true;return}if(r.dirAx!==s){r.distAxX=0;r.distAxY=0}else{r.distAxX+=Math.abs(r.distX);if(r.dirX!==0&&r.dirX!==r.lastDirX){r.distAxX=0}r.distAxY+=Math.abs(r.distY);if(r.dirY!==0&&r.dirY!==r.lastDirY){r.distAxY=0}}r.dirAx=s;if(r.dirAx&&r.distAxX>=u.threshold){r.distAxX=0;x=this.placeEl.prev(u.itemNodeName);if(r.distX>0&&x.length&&!x.hasClass(u.collapsedClass)){q=x.find(u.listNodeName).last();m=this.placeEl.parents(u.listNodeName).length;if(m+this.dragDepth<=u.maxDepth){if(!q.length){q=a("<"+u.listNodeName+"/>").addClass(u.listClass);q.append(this.placeEl);x.append(q);this.setParent(x)}else{q=x.children(u.listNodeName).last();q.append(this.placeEl)}}}if(r.distX<0){t=this.placeEl.next(u.itemNodeName);if(!t.length){v=this.placeEl.parent();this.placeEl.closest(u.itemNodeName).after(this.placeEl);if(!v.children().length){this.unsetParent(v.parent())}}}}var o=false;if(!g){this.dragEl[0].style.visibility="hidden"}this.pointEl=a(c.elementFromPoint(n.pageX-c.body.scrollLeft,n.pageY-(k.pageYOffset||c.documentElement.scrollTop)));if(!g){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(u.handleClass)){this.pointEl=this.pointEl.parent(u.itemNodeName)}if(this.pointEl.hasClass(u.emptyClass)){o=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(u.itemClass)){return}}var w=this.pointEl.closest("."+u.rootClass),p=this.dragRootEl.data("nestable-id")!==w.data("nestable-id");if(!r.dirAx||p||o){if(p&&u.group!==w.data("nestable-group")){return}m=this.dragDepth-1+this.pointEl.parents(u.listNodeName).length;if(m>u.maxDepth){return}var l=n.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);v=this.placeEl.parent();if(o){q=a(c.createElement(u.listNodeName)).addClass(u.listClass);q.append(this.placeEl);this.pointEl.replaceWith(q)}else{if(l){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!v.children().length){this.unsetParent(v.parent())}if(!this.dragRootEl.find(u.itemNodeName).length){this.dragRootEl.append('<div class="'+u.emptyClass+'"/>')}if(p){this.dragRootEl=w;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};a.fn.nestable=function(m){var l=this,n=this;l.each(function(){var o=a(this).data("nestable");if(!o){a(this).data("nestable",new i(this,m));a(this).data("nestable-id",new Date().getTime())}else{if(typeof m==="string"&&typeof o[m]==="function"){n=o[m]()}}});return n||l}})(window.jQuery||window.Zepto,window,document);